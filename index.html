<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMEA Vision Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Cores de Nível para CSS */
            --c-root: #3b82f6;
            --c-sys: #10b981;
            --c-sub: #06b6d4;
            --c-comp: #8b5cf6;
            --c-fail: #ec4899;
            --c-cause: #f97316;
            --c-task: #64748b;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            /* Fundo Rico e Vibrante */
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(6, 182, 212, 0.1) 0px, transparent 50%);
            color: #1e293b;
        }

        /* --- Glassmorphism Premium --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.05), 
                0 10px 15px -3px rgba(0, 0, 0, 0.05),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5); /* Inner border light */
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .glass-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        /* --- D3 Graph Styles --- */
        
        /* Links (Linhas) */
        .link {
            fill: none;
            stroke: #94a3b8; 
            stroke-width: 2px; /* Mais grossa para visibilidade */
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0.6;
            transition: opacity 0.3s;
        }
        
        .link.dimmed { opacity: 0.1; }

        /* Nodes */
        .node { cursor: pointer; }
        .node.dimmed { opacity: 0.1; pointer-events: none; }

        /* O Balão de Vidro do Nó */
        .node rect.main-box {
            fill: rgba(255, 255, 255, 0.85); /* Mais opaco para contraste */
            stroke: rgba(255, 255, 255, 1);
            stroke-width: 1.5px;
            rx: 12; ry: 12;
            /* Sombra suave colorida baseada no contexto */
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.08)); 
            transition: all 0.3s ease;
        }

        .node:hover rect.main-box {
            fill: #ffffff;
            stroke: #3b82f6;
            filter: drop-shadow(0 8px 20px rgba(59, 130, 246, 0.25)); /* Glow azul ao hover */
            transform: scale(1.02); /* Leve zoom */
        }

        /* Texto */
        .node text {
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 600;
            fill: #1e293b; /* Dark slate */
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(255,255,255,1);
        }

        /* Indicador de Expansão (+/-) */
        .indicator-circle {
            fill: #f1f5f9;
            stroke: #cbd5e1;
            stroke-width: 1.5px;
            transition: all 0.2s;
        }
        .node:hover .indicator-circle {
            fill: #3b82f6;
            stroke: #2563eb;
        }
        .indicator-text {
            font-size: 10px;
            font-weight: 800;
            fill: #64748b;
            text-anchor: middle;
            alignment-baseline: middle;
            pointer-events: none;
        }
        .node:hover .indicator-text { fill: #ffffff; }

        /* Color Strips (Indicadores de Nível) */
        .node.level-root rect.color-strip { fill: var(--c-root); }      
        .node.level-system rect.color-strip { fill: var(--c-sys); }    
        .node.level-subsystem rect.color-strip { fill: var(--c-sub); } 
        .node.level-component rect.color-strip { fill: var(--c-comp); } 
        .node.level-failure rect.color-strip { fill: var(--c-fail); }   
        .node.level-cause rect.color-strip { fill: var(--c-cause); }     
        .node.level-task rect.color-strip { fill: var(--c-task); }      

        /* Full Screen Drop Overlay */
        #drag-overlay {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        body.dragging #drag-overlay { opacity: 1; pointer-events: all; }

        /* Animations */
        .animate-in { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.4); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(100, 116, 139, 0.7); }

        /* Dock Buttons */
        .dock-btn {
            position: relative;
            overflow: hidden;
        }
        .dock-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(255,255,255,0.8) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .dock-btn:hover::after { opacity: 1; }
    </style>
</head>
<body class="h-screen flex flex-col relative selection:bg-indigo-100 selection:text-indigo-900">

    <!-- Drag Overlay -->
    <div id="drag-overlay" class="absolute inset-4 rounded-[2rem] border-4 border-dashed border-blue-400 flex flex-col items-center justify-center text-blue-600">
        <div class="bg-white/80 p-8 rounded-full shadow-2xl backdrop-blur-xl animate-bounce">
            <i data-lucide="upload-cloud" class="w-16 h-16"></i>
        </div>
        <h2 class="text-3xl font-bold mt-6 text-slate-800">Solte o arquivo aqui</h2>
        <p class="text-lg text-slate-500 mt-2 font-medium">Processamento instantâneo de FMEA</p>
    </div>

    <!-- Header -->
    <header class="absolute top-4 left-6 right-6 h-20 glass-panel rounded-2xl z-30 flex justify-between items-center px-8 transition-all duration-500" id="main-header">
        <div class="flex items-center gap-5">
            <div class="w-12 h-12 bg-gradient-to-tr from-blue-600 to-violet-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-500/25 ring-1 ring-white/50">
                <i data-lucide="network" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-bold text-slate-800 text-xl tracking-tight">FMEA Vision <span class="text-blue-600">.Pro</span></h1>
                <p class="text-xs text-slate-500 font-medium tracking-wide mt-0.5">Ferramenta Executiva de Análise de Risco</p>
            </div>

            <div id="sheet-selector-wrapper" class="hidden ml-8 flex items-center gap-3 bg-slate-100/50 p-1.5 px-4 rounded-full border border-white shadow-sm hover:bg-white/80 transition-all">
                <i data-lucide="layers" class="w-4 h-4 text-slate-400"></i>
                <select id="sheetSelector" class="bg-transparent text-xs font-bold text-slate-600 outline-none cursor-pointer min-w-[120px] uppercase tracking-wide">
                </select>
            </div>
        </div>

        <!-- Botão Isolar / Carregar -->
        <div class="flex items-center gap-4">
             <!-- Banner Foco -->
            <div id="focus-banner" class="hidden flex items-center gap-3 bg-slate-900/90 text-white px-5 py-2.5 rounded-full shadow-xl backdrop-blur-md border border-white/10 animate-in">
                <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                <span class="text-xs font-bold tracking-wider uppercase">Foco Ativo</span>
                <button onclick="clearFocus()" class="ml-2 hover:bg-white/20 p-1.5 rounded-full transition-colors" title="Limpar Foco">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            </div>

            <div class="relative group">
                 <input type="file" id="fileUploader" accept=".csv, .xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                 <button class="flex items-center gap-2 px-5 py-2.5 bg-white hover:bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 shadow-sm transition-all hover:shadow-md hover:border-blue-300 hover:text-blue-600">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    <span>Novo Arquivo</span>
                 </button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="flex-1 w-full h-full relative overflow-hidden">
        
        <div id="tree-container" class="w-full h-full cursor-grab active:cursor-grabbing">
            <div id="empty-state" class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
                <div class="glass-panel p-10 rounded-[2.5rem] text-center max-w-lg mx-6 border border-white/60">
                    <div class="w-20 h-20 bg-blue-50 rounded-3xl flex items-center justify-center mx-auto mb-6 text-blue-600 shadow-inner">
                        <i data-lucide="layout-dashboard" class="w-10 h-10"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-3">Espaço de Trabalho Vazio</h2>
                    <p class="text-slate-500 leading-relaxed font-medium">Arraste seu arquivo FMEA (.xlsx) para qualquer lugar da tela para começar a visualização imersiva.</p>
                </div>
            </div>
        </div>

        <!-- Dock de Controle -->
        <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 glass-panel px-4 py-3 rounded-2xl flex gap-3 z-40 shadow-2xl animate-in">
            <!-- Níveis -->
            <div class="flex gap-2 pr-4 border-r border-slate-200/50">
                <button class="dock-btn w-11 h-11 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 transition-colors" onclick="expandToLevel(1)" title="Sistema">
                    <span class="text-[9px] font-black tracking-tighter">SYS</span>
                    <div class="w-1 h-1 rounded-full bg-emerald-500 mt-0.5 opacity-50"></div>
                </button>
                <button class="dock-btn w-11 h-11 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:text-cyan-600 hover:bg-cyan-50 transition-colors" onclick="expandToLevel(2)" title="Subsistema">
                    <span class="text-[9px] font-black tracking-tighter">SUB</span>
                    <div class="w-1 h-1 rounded-full bg-cyan-500 mt-0.5 opacity-50"></div>
                </button>
                <button class="dock-btn w-11 h-11 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:text-violet-600 hover:bg-violet-50 transition-colors" onclick="expandToLevel(3)" title="Componente">
                    <span class="text-[9px] font-black tracking-tighter">COM</span>
                    <div class="w-1 h-1 rounded-full bg-violet-500 mt-0.5 opacity-50"></div>
                </button>
                <button class="dock-btn w-11 h-11 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:text-pink-600 hover:bg-pink-50 transition-colors" onclick="expandToLevel(4)" title="Falha">
                    <span class="text-[9px] font-black tracking-tighter">MOD</span>
                    <div class="w-1 h-1 rounded-full bg-pink-500 mt-0.5 opacity-50"></div>
                </button>
                <button class="dock-btn w-11 h-11 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:text-orange-600 hover:bg-orange-50 transition-colors" onclick="expandToLevel(5)" title="Causa">
                    <span class="text-[9px] font-black tracking-tighter">CAU</span>
                    <div class="w-1 h-1 rounded-full bg-orange-500 mt-0.5 opacity-50"></div>
                </button>
                <button class="dock-btn w-11 h-11 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:text-slate-700 hover:bg-slate-100 transition-colors" onclick="expandToLevel(6)" title="Tarefa">
                    <span class="text-[9px] font-black tracking-tighter">TSK</span>
                    <div class="w-1 h-1 rounded-full bg-slate-500 mt-0.5 opacity-50"></div>
                </button>
            </div>
            
            <!-- Ações -->
            <div class="flex gap-2 pl-1">
                <button class="dock-btn w-11 h-11 rounded-xl flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-blue-50 transition-colors" onclick="expandAll()" title="Expandir Tudo">
                    <i data-lucide="maximize" class="w-5 h-5"></i>
                </button>
                <button class="dock-btn w-11 h-11 rounded-xl flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-blue-50 transition-colors" onclick="collapseAll()" title="Recolher Tudo">
                    <i data-lucide="minimize" class="w-5 h-5"></i>
                </button>
                <button class="dock-btn w-11 h-11 rounded-xl flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-blue-50 transition-colors" onclick="resetZoom()" title="Centralizar">
                    <i data-lucide="focus" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Painel Lateral -->
        <aside id="details-panel" class="absolute top-28 bottom-8 right-8 w-[400px] glass-panel rounded-3xl translate-x-[150%] transition-transform duration-500 ease-[cubic-bezier(0.25,1,0.5,1)] z-50 flex flex-col shadow-2xl overflow-hidden border border-white/50">
            <!-- Header -->
            <div class="p-6 border-b border-slate-100 bg-white/40 backdrop-blur-md flex justify-between items-start shrink-0">
                <div class="flex-1 mr-4 overflow-hidden">
                    <div id="panel-tag" class="inline-flex items-center px-2 py-1 rounded text-[10px] font-extrabold uppercase tracking-widest mb-2 bg-white/80 border border-white shadow-sm text-slate-500">
                        INFO
                    </div>
                    <h3 id="panel-title" class="text-lg font-bold text-slate-900 leading-snug break-words">Titulo do Item</h3>
                </div>
                <div class="flex gap-2">
                    <button onclick="focusOnNode()" class="w-9 h-9 flex items-center justify-center rounded-full bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition-all shadow-sm border border-blue-100" title="Isolar Ramo">
                        <i data-lucide="crosshair" class="w-4 h-4"></i>
                    </button>
                    <button onclick="closePanel()" class="w-9 h-9 flex items-center justify-center rounded-full bg-white text-slate-400 hover:bg-slate-100 hover:text-slate-700 transition-all shadow-sm border border-slate-100">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-white/20">
                <div>
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 pl-1">Descrição Completa</h4>
                    <div class="bg-white/70 p-5 rounded-2xl border border-white shadow-sm">
                        <p id="panel-desc" class="text-sm text-slate-700 leading-relaxed font-medium">-</p>
                    </div>
                </div>

                <div id="extra-details" class="space-y-5 hidden"></div>

                <div id="risk-metrics" class="hidden">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 pl-1 flex items-center gap-2">
                        <i data-lucide="activity" class="w-3 h-3"></i> Indicadores de Risco
                    </h4>
                    
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-rose-50/80 p-3 rounded-2xl text-center border border-rose-100 shadow-sm">
                            <span class="block text-[9px] text-rose-400 font-extrabold uppercase mb-1">Severidade</span>
                            <span id="val-sev" class="text-sm font-bold text-rose-700 leading-tight block break-words">-</span>
                        </div>
                        <div class="bg-amber-50/80 p-3 rounded-2xl text-center border border-amber-100 shadow-sm">
                            <span class="block text-[9px] text-amber-400 font-extrabold uppercase mb-1">Ocorrência</span>
                            <span id="val-occ" class="text-sm font-bold text-amber-700 leading-tight block break-words">-</span>
                        </div>
                        <div class="bg-sky-50/80 p-3 rounded-2xl text-center border border-sky-100 shadow-sm">
                            <span class="block text-[9px] text-sky-400 font-extrabold uppercase mb-1">Detecção</span>
                            <span id="val-det" class="text-sm font-bold text-sky-700 leading-tight block break-words">-</span>
                        </div>
                    </div>
                    
                    <div class="relative overflow-hidden rounded-2xl bg-slate-900 p-5 text-white shadow-xl group">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500 rounded-full blur-2xl opacity-20 group-hover:opacity-40 transition-opacity"></div>
                        <div class="relative z-10 flex justify-between items-center">
                            <span class="text-xs font-bold uppercase tracking-widest text-slate-400">RPN Score</span>
                            <span id="val-rpn" class="text-3xl font-black tracking-tight text-white">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

    </main>

    <!-- Tooltip -->
    <div id="graph-tooltip" class="fixed bg-slate-800/90 backdrop-blur-md text-white text-xs px-4 py-2.5 rounded-xl shadow-2xl pointer-events-none opacity-0 z-[60] transform -translate-x-1/2 -translate-y-full transition-all duration-200 font-medium border border-white/10 max-w-xs text-center"></div>

    <script>
        lucide.createIcons();

        // --- Configs ---
        let svg, g, tree, root;
        let currentNode = null;
        let focusNodeData = null;
        let currentWorkbook = null;
        let zoom;
        const duration = 600; // Animação suave
        let i = 0;

        // D3 Tree Config
        const NODE_HEIGHT = 46;
        const NODE_MIN_WIDTH = 160; 
        const CHAR_WIDTH = 7; 
        const HORIZONTAL_SPACING = 380; 

        const COL_MAPPING = {
            System: ['system', 'sistema'],
            SubSystem: ['subsystem', 'subsistema', 'sub-sistema'],
            Function: ['function', 'função', 'funcao'],
            Component: ['component', 'componente'],
            FailureMode: ['failuremode', 'modo de falha', 'failure mode', 'modofalha'],
            Effects: ['effects', 'efeitos', 'efeito'],
            Cause: ['cause', 'causa', 'causaraiz'],
            Task: ['task', 'nome da tarefa', 'tarefa'],
            TaskDescription: ['taskdescription', 'descrição da tarefa', 'descricao', 'description'],
            ScheduleType: ['scheduletype', 'tipo de agendamento', 'agendamento'],
            TaskType: ['tasktype', 'tipo de tarefa'],
            Interval: ['interval', 'intervalo'],
            Severity: ['severity', 'severidade'],
            Occurrence: ['occurrence', 'ocorrência', 'ocorrencia'],
            Detection: ['detection', 'detecção', 'deteccao'],
            RPN: ['rpn']
        };

        // --- Drag & Drop ---
        const body = document.body;
        const dragOverlay = document.getElementById('drag-overlay');

        ['dragenter', 'dragover'].forEach(e => document.addEventListener(e, (ev) => { ev.preventDefault(); body.classList.add('dragging'); }));
        ['dragleave', 'drop'].forEach(e => dragOverlay.addEventListener(e, (ev) => { ev.preventDefault(); if(e==='drop' || ev.target===dragOverlay) body.classList.remove('dragging'); }));
        document.addEventListener('drop', (e) => { e.preventDefault(); body.classList.remove('dragging'); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
        document.getElementById('fileUploader').addEventListener('change', (e) => { if(e.target.files.length) handleFile(e.target.files[0]); });

        // --- Processing ---
        function handleFile(file) {
            document.getElementById('empty-state').classList.add('hidden');
            d3.select("#tree-container svg").remove();
            
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext === 'csv') {
                Papa.parse(file, { header: false, skipEmptyLines: false, complete: res => processData(res.data, file.name) });
            } else if (['xlsx', 'xls', 'xlsm'].includes(ext)) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    currentWorkbook = XLSX.read(data, {type: 'array'});
                    setupSheetSelector(currentWorkbook.SheetNames, file.name);
                    processExcelSheet(currentWorkbook.SheetNames[0], file.name);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function setupSheetSelector(sheets, fileName) {
            const wrapper = document.getElementById('sheet-selector-wrapper');
            const select = document.getElementById('sheetSelector');
            wrapper.classList.remove('hidden');
            select.innerHTML = '';
            sheets.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.innerText = s;
                select.appendChild(opt);
            });
            select.onchange = (e) => processExcelSheet(e.target.value, fileName);
        }

        function processExcelSheet(sheetName, fileName) {
            const ws = currentWorkbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(ws, {header: 1, defval: ""});
            processData(data, fileName + ' - ' + sheetName);
        }

        function processData(rawData, rootName) {
            if (!rawData || rawData.length < 4) { alert("Arquivo inválido."); return; }
            const headers = rawData[0].map(h => h ? String(h).trim().toLowerCase() : "");
            const rows = rawData.slice(3);
            const map = {};
            for (const key in COL_MAPPING) map[key] = headers.findIndex(h => COL_MAPPING[key].some(k => h.includes(k)));
            
            if (map.System === -1) {
                map.System = 1; map.SubSystem = 2; map.Function = 3; map.Component = 6; map.FailureMode = 7; 
                map.Effects = 8; map.Cause = 9; map.Severity = 10; map.Occurrence = 11; map.Detection = 12; 
                map.RPN = 13; map.Task = 14; map.TaskDescription = 15; map.ScheduleType = 16; map.TaskType = 17; map.Interval = 18;
            }

            let last = { System: "?", SubSystem: "?", Component: "?", FailureMode: "?", Cause: "?" };
            const hierarchy = { name: rootName, level: 'root', children: [] };

            rows.forEach(row => {
                const get = (idx) => (idx > -1 && row[idx] !== undefined) ? String(row[idx]).trim() : "";
                
                let sys = get(map.System) || last.System;
                let sub = get(map.SubSystem) || (map.SubSystem > -1 ? last.SubSystem : "Geral");
                let comp = get(map.Component) || last.Component;
                let fail = get(map.FailureMode) || last.FailureMode;
                let cause = get(map.Cause) || last.Cause;
                let task = get(map.Task);

                if(get(map.System)) last.System = sys;
                if(get(map.SubSystem)) last.SubSystem = sub;
                if(get(map.Component)) last.Component = comp;
                if(get(map.FailureMode)) last.FailureMode = fail;
                if(get(map.Cause)) last.Cause = cause;

                if (sys === "?" && comp === "?") return;

                let sysNode = findOrAdd(hierarchy, sys, 'system');
                let subNode = findOrAdd(sysNode, sub, 'subsystem');
                if(get(map.Function) && !subNode.function) subNode.function = get(map.Function);
                let compNode = findOrAdd(subNode, comp, 'component');
                let failNode = findOrAdd(compNode, fail, 'failure');
                if(get(map.Effects) && !failNode.effects) failNode.effects = get(map.Effects);
                
                let causeNode = failNode.children.find(c => c.name === cause);
                if (!causeNode) {
                    causeNode = { name: cause, level: 'cause', metrics: { sev: get(map.Severity), occ: get(map.Occurrence), det: get(map.Detection), rpn: get(map.RPN) }, children: [] };
                    failNode.children.push(causeNode);
                }
                if (task) {
                    causeNode.children.push({ name: task, level: 'task', taskDetails: { description: get(map.TaskDescription), schedule: get(map.ScheduleType), type: get(map.TaskType), interval: get(map.Interval) }, children: null });
                }
            });

            initTree(hierarchy);
        }

        function findOrAdd(parent, name, level) {
            let node = parent.children.find(c => c.name === name);
            if (!node) { node = { name: name, level: level, children: [] }; parent.children.push(node); }
            return node;
        }

        // --- D3 Init ---
        function initTree(data) {
            const container = document.getElementById('tree-container');
            const w = container.clientWidth;
            const h = container.clientHeight;
            d3.select("#tree-container svg").remove();
            
            svg = d3.select("#tree-container").append("svg").attr("width", w).attr("height", h)
                .call(d3.zoom().on("zoom", (e) => g.attr("transform", e.transform))).on("dblclick.zoom", null);
            g = svg.append("g").attr("transform", "translate(100,0)");
            zoom = d3.zoom().on("zoom", (e) => g.attr("transform", e.transform));
            svg.call(zoom);

            root = d3.hierarchy(data, d => d.children);
            root.x0 = h / 2;
            root.y0 = 0;

            if(root.children) root.children.forEach(sys => { if(sys.children) sys.children.forEach(collapse); });
            update(root);
            resetZoom();
        }

        // --- D3 Update (Animation Logic Improved) ---
        function update(source) {
            const levelWidth = HORIZONTAL_SPACING;
            tree = d3.tree().nodeSize([60, levelWidth]);
            const treeData = tree(root);
            const nodes = treeData.descendants();
            const links = treeData.links();

            nodes.forEach(d => d.y = d.depth * HORIZONTAL_SPACING);

            // --- Nodes ---
            const node = g.selectAll('g.node').data(nodes, d => d.id || (d.id = ++i));

            // Enter
            const nodeEnter = node.enter().append('g')
                .attr('class', d => `node level-${d.data.level} ${isDimmed(d) ? 'dimmed' : ''}`)
                .attr("transform", d => `translate(${source.y0},${source.x0})`)
                .on('click', click);

            nodeEnter.append('rect').attr('class', 'main-box')
                .attr('height', NODE_HEIGHT).attr('x', 0).attr('y', -NODE_HEIGHT / 2)
                .attr('width', 0) // Start width 0 for transition
                .transition().duration(duration)
                .attr('width', d => Math.min(Math.max(NODE_MIN_WIDTH, (d.data.name ? d.data.name.length : 0) * CHAR_WIDTH + 30), 400));

            nodeEnter.append('rect').attr('class', 'color-strip')
                .attr('width', 5).attr('height', NODE_HEIGHT).attr('x', 0).attr('y', -NODE_HEIGHT / 2).attr('rx', 4)
                .style('clip-path', 'inset(0px 0px 0px 0px round 4px 0px 0px 4px)');

            nodeEnter.append('text').attr("dy", ".35em").attr("x", 16)
                .style("opacity", 0) // Start transparent
                .text(d => { const t = d.data.name||""; return t.length>55 ? t.substring(0,55)+"..." : t; })
                .transition().duration(duration).style("opacity", 1);

            const indicator = nodeEnter.append('g').attr('class', 'indicator-group')
                .style('display', d => (d.children || d._children) ? 'block' : 'none');
            indicator.append('circle').attr('class', 'indicator-circle').attr('r', 9);
            indicator.append('text').attr('class', 'indicator-text').attr('dy', 1).text('+');

            // Update
            const nodeUpdate = node.merge(nodeEnter).transition().duration(duration)
                .attr("transform", d => `translate(${d.y},${d.x})`)
                .attr('class', d => `node level-${d.data.level} ${isDimmed(d) ? 'dimmed' : ''}`);

            nodeUpdate.select('rect.main-box')
                .attr('width', d => Math.min(Math.max(NODE_MIN_WIDTH, (d.data.name ? d.data.name.length : 0) * CHAR_WIDTH + 30), 400));

            nodeUpdate.select('.indicator-group')
                .attr('transform', d => `translate(${Math.min(Math.max(NODE_MIN_WIDTH, (d.data.name ? d.data.name.length : 0) * CHAR_WIDTH + 30), 400)}, 0)`)
                .style('display', d => (d.children || d._children) ? 'block' : 'none');
            
            nodeUpdate.select('.indicator-text').text(d => d._children ? "+" : "-");

            // Exit
            const nodeExit = node.exit().transition().duration(duration)
                .attr("transform", d => `translate(${source.y},${source.x})`)
                .remove();
            nodeExit.select('rect.main-box').attr('width', 0);
            nodeExit.select('text').style('opacity', 0);
            nodeExit.select('.indicator-group').style('opacity', 0);

            // --- Links (Improved Animation) ---
            const link = g.selectAll('path.link').data(links, d => d.target.id);

            // Enter: Draw link starting from parent's previous position
            const linkEnter = link.enter().insert('path', "g")
                .attr("class", d => `link ${isLinkDimmed(d.target) ? 'dimmed' : ''}`)
                .attr('d', d => {
                    const o = {x: source.x0, y: source.y0};
                    return diagonal(o, o); // Collapsed at parent
                });

            // Update: Transition to target's new position
            link.merge(linkEnter).transition().duration(duration)
                .attr('d', d => {
                    const w = Math.min(Math.max(NODE_MIN_WIDTH, (d.source.data.name ? d.source.data.name.length : 0) * CHAR_WIDTH + 30), 400);
                    return diagonalComplex(d.source, d.target, w);
                })
                .attr("class", d => `link ${isLinkDimmed(d.target) ? 'dimmed' : ''}`);

            // Exit: Transition back to source's NEW position (collapsing)
            link.exit().transition().duration(duration)
                .attr('d', d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .remove();

            // Stash positions
            nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
        }

        // --- Utils ---
        function diagonalComplex(s, d, sWidth) {
            const sourceX = s.y + sWidth; const sourceY = s.x;
            const targetX = d.y; const targetY = d.x;
            return `M ${sourceX} ${sourceY} C ${(sourceX + targetX) / 2} ${sourceY}, ${(sourceX + targetX) / 2} ${targetY}, ${targetX} ${targetY}`;
        }
        function diagonal(s, d) {
             return `M ${s.y} ${s.x} C ${(s.y + d.y) / 2} ${s.x}, ${(s.y + d.y) / 2} ${d.x}, ${d.y} ${d.x}`;
        }
        function focusOnNode() {
            if (!currentNode) return;
            focusNodeData = currentNode;
            closePanel();
            document.getElementById('focus-banner').classList.remove('hidden');
            expand(focusNodeData); update(root);
            const w = document.getElementById('tree-container').clientWidth;
            const h = document.getElementById('tree-container').clientHeight;
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(-focusNodeData.y + w/2 - 200, -focusNodeData.x + h/2).scale(1));
        }
        function clearFocus() { focusNodeData = null; document.getElementById('focus-banner').classList.add('hidden'); update(root); }
        function isDimmed(d) {
            if (!focusNodeData) return false;
            if (d === focusNodeData || d.ancestors().includes(focusNodeData) || focusNodeData.ancestors().includes(d)) return false;
            return true;
        }
        function isLinkDimmed(t) { return isDimmed(t); }
        function click(event, d) {
            if (d.children) { d._children = d.children; d.children = null; } else { d.children = d._children; d._children = null; }
            update(d); showDetails(d);
            if (focusNodeData) update(root);
        }
        function expand(d) { if(d._children){d.children=d._children; d._children=null;} if(d.children)d.children.forEach(expand); }
        function collapse(d) { if(d.children){d._children=d.children; d._children.forEach(collapse); d.children=null;} }
        function expandToLevel(lvl) { if(!root)return; expand(root); root.each(d => { if(d.depth>=lvl) collapse(d); }); update(root); resetZoom(); }
        function expandAll() { if(!root)return; expand(root); update(root); }
        function collapseAll() { if(!root)return; if(root.children)root.children.forEach(collapse); update(root); resetZoom(); }
        function resetZoom() { if(!svg)return; const h = document.getElementById('tree-container').clientHeight; svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(80, h/2).scale(1)); }

        // --- Panel ---
        function showDetails(d) {
            currentNode = d;
            const panel = document.getElementById('details-panel');
            panel.classList.remove('translate-x-[150%]');
            document.getElementById('panel-title').innerText = d.data.name;
            document.getElementById('panel-desc').innerText = d.data.name;
            document.getElementById('panel-tag').innerText = d.data.level;
            
            const extra = document.getElementById('extra-details'); extra.innerHTML = ''; extra.classList.add('hidden');
            let html = '';
            if (d.data.level === 'subsystem' && d.data.function) html += mkCard('Função', d.data.function, 'settings');
            if (d.data.level === 'failure' && d.data.effects) html += mkCard('Efeitos', d.data.effects, 'alert-triangle');
            if (d.data.level === 'task' && d.data.taskDetails) {
                const td = d.data.taskDetails;
                if(td.description) html += mkCard('Descrição', td.description, 'file-text');
                if(td.type || td.interval) html += `<div class="grid grid-cols-2 gap-3"><div class="glass-card p-3 rounded-2xl text-center"><div class="text-[9px] font-bold text-slate-400 uppercase">Tipo</div><div class="text-sm font-bold text-slate-700">${td.type||'-'}</div></div><div class="glass-card p-3 rounded-2xl text-center"><div class="text-[9px] font-bold text-slate-400 uppercase">Intervalo</div><div class="text-sm font-bold text-slate-700">${td.interval?td.interval+' dias':'-'}</div></div></div>`;
            }
            if(html) { extra.innerHTML = html; extra.classList.remove('hidden'); lucide.createIcons(); }

            const metrics = document.getElementById('risk-metrics');
            if (d.data.level === 'cause' && d.data.metrics) {
                metrics.classList.remove('hidden');
                document.getElementById('val-sev').innerText = d.data.metrics.sev || '-';
                document.getElementById('val-occ').innerText = d.data.metrics.occ || '-';
                document.getElementById('val-det').innerText = d.data.metrics.det || '-';
                document.getElementById('val-rpn').innerText = d.data.metrics.rpn || '-';
            } else { metrics.classList.add('hidden'); }
        }
        function mkCard(l, t, i) { return `<div class="glass-card p-5 rounded-2xl border border-white/50"><h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="${i}" class="w-3 h-3"></i> ${l}</h5><p class="text-sm text-slate-700 leading-relaxed font-medium">${t}</p></div>`; }
        function closePanel() { document.getElementById('details-panel').classList.add('translate-x-[150%]'); }
    </script>
</body>
</html>